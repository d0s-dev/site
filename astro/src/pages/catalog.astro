---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchCatalogData } from "../lib/catalog/data-source";
import { mockCatalogResponse, sumSeverity } from "../lib/catalog/mock-data";
import type { CatalogApp, SeveritySummary } from "../lib/catalog/types";

const formatDate = (input: string) =>
  new Date(input).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });

const severityOrder = ["critical", "high", "medium", "low"] as const;
const severityLabelMap: Record<(typeof severityOrder)[number], string> = {
  critical: "Critical",
  high: "High",
  medium: "Medium",
  low: "Low",
};
const severityColorMap: Record<(typeof severityOrder)[number], string> = {
  critical: "#FF6B6B",
  high: "#F59F00",
  medium: "#FAB005",
  low: "#4DABF7",
};

const catalogResult = await fetchCatalogData();
const catalogResponse = catalogResult.response ?? mockCatalogResponse;
const catalogApps = (catalogResponse.apps ?? []) as CatalogApp[];
const totalPackages = catalogApps.length;
const totalVersions = catalogApps.reduce((acc, app) => acc + (app.versionCount ?? 1), 0);
const totalBuilds = catalogApps.reduce((acc, app) => acc + (app.buildCount ?? app.imageCount ?? 0), 0);

const formatNumber = (value: number) =>
  new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(value);

const lastUpdatedIso = catalogResponse.lastUpdated ?? new Date(catalogResult.fetchedAt).toISOString();
const formattedLastUpdated = formatDate(lastUpdatedIso);

const severityTotals = sumSeverity(catalogApps);
const totalVulnerabilities = severityOrder.reduce((acc, key) => acc + (severityTotals[key] ?? 0), 0);
const severityMax = Math.max(...severityOrder.map((key) => severityTotals[key] ?? 0), 1);
const severitySeries = severityOrder.map((key) => ({
  key,
  label: severityLabelMap[key],
  count: severityTotals[key] ?? 0,
  width: Math.round(((severityTotals[key] ?? 0) / severityMax) * 100),
  color: severityColorMap[key],
}));

const labelOptions = [
  "all",
  ...Array.from(new Set(catalogApps.flatMap((app) => app.labels ?? []))).sort((a, b) => a.localeCompare(b)),
];

const providerOptions: Array<{ value: string; label: string }> = [
  { value: "all", label: "All providers" },
  { value: "ironbank", label: "Iron Bank available" },
  { value: "chainguard", label: "Chainguard available" },
  { value: "vendor", label: "Vendor only" },
];

const mapAppToSearchText = (app: CatalogApp) =>
  [app.name, app.summary, ...(app.labels ?? []), ...(app.providers ?? [])]
    .filter(Boolean)
    .join(" ")
    .toLowerCase();

const viewModels = catalogApps.map((app) => ({
  id: app.id,
  name: app.name,
  summary: app.summary,
  labels: app.labels ?? [],
  providers: app.providers ?? [],
  hasIronBank: app.hasIronBank,
  hasChainguard: app.hasChainguard,
  vendorOnly: app.providers?.length === 1 && app.providers[0] === "vendor",
  imageCount: app.imageCount,
  cves: app.cves,
  latestVersion: app.latestVersion,
  zarfPackage: app.zarfPackage,
  links: app.links ?? {},
  logoUrl: app.logoUrl ?? null,
  searchText: mapAppToSearchText(app),
}));

const sourceLabelMap = {
  remote: "Live GitHub data",
  cache: "Cached GitHub data",
  mock: "Mock dataset",
} as const;

const catalogSourceLabel = sourceLabelMap[catalogResult.source] ?? "Unknown";

const cveChartPayload = {
  labels: severityOrder.map((key) => severityLabelMap[key]),
  datasets: [
    {
      label: "Findings",
      data: severityOrder.map((key) => severityTotals[key] ?? 0),
      backgroundColor: severityOrder.map((key) => severityColorMap[key]),
      borderWidth: 0,
    },
  ],
};

const severityToString = (severity: SeveritySummary | undefined) =>
  severityOrder
    .map((key) => severity?.[key] ?? 0)
    .join(" / ");

const serializeJson = (input: unknown) =>
  JSON.stringify(input)
    .replace(/</g, "\\u003c")
    .replace(/>/g, "\\u003e")
    .replace(/&/g, "\\u0026");
---

<BaseLayout
  title="Catalog | d0s.dev"
  description="Explore hardened application bundles ready for disconnected deployment."
  current="catalog"
>
  <section class="px-4 pt-20 pb-6 sm:px-6 lg:px-12">
    <div class="mx-auto max-w-7xl">
      <!-- Slim stats bar along the top -->
      <div class="flex flex-wrap items-center justify-center gap-6 text-center mb-6">
        <div class="flex items-baseline gap-2">
          <span class="text-2xl font-semibold text-white">{formatNumber(totalPackages)}</span>
          <span class="text-xs uppercase tracking-wider text-brand-gray-300">Apps</span>
        </div>
        <div class="h-4 w-px bg-brand-blue-300/50"></div>
        <div class="flex items-baseline gap-2">
          <span class="text-2xl font-semibold text-white">{formatNumber(totalVersions)}</span>
          <span class="text-xs uppercase tracking-wider text-brand-gray-300">Versions</span>
        </div>
        <div class="h-4 w-px bg-brand-blue-300/50"></div>
        <div class="flex items-baseline gap-2">
          <span class="text-2xl font-semibold text-white">{formatNumber(totalBuilds)}</span>
          <span class="text-xs uppercase tracking-wider text-brand-gray-300">Builds</span>
        </div>
      </div>

      <!-- Search and filter section - no box, flows with page -->
      <div class="flex flex-col lg:flex-row items-center justify-center gap-4 mb-8">
        <!-- Search bar - main focus -->
        <div class="w-full max-w-2xl">
          <label class="sr-only" for="catalog-search">Search catalog</label>
          <div class="flex items-center gap-3 rounded-full border border-brand-blue-300 bg-brand-blue-500/30 px-5 py-3 text-sm text-brand-gray-100 focus-within:border-brand-blue-100 focus-within:text-white">
            <svg aria-hidden="true" class="size-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input
              id="catalog-search"
              type="search"
              placeholder="Search catalog..."
              class="w-full bg-transparent text-base text-white placeholder:text-brand-gray-300 focus:outline-none"
              data-filter-search
            />
          </div>
        </div>
        
        <!-- Filters to the right, vertically aligned -->
        <div class="flex flex-col gap-3">
          <div class="relative min-w-[200px]">
            <label class="sr-only" for="catalog-label-filter">Filter by label</label>
            <select
              id="catalog-label-filter"
              class="w-full appearance-none rounded-full border border-brand-blue-300 bg-brand-gray-500 px-4 py-3 pr-10 text-sm text-white transition focus:border-brand-blue-100 focus:outline-none"
              data-filter-label-select
            >
              {labelOptions.map((value) => (
                <option value={value} class="bg-brand-gray-500 text-white">{value === "all" ? "All labels" : value}</option>
              ))}
            </select>
            <span class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-brand-blue-100">
              <svg aria-hidden="true" class="size-4" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </span>
          </div>
          <div class="relative min-w-[200px]">
            <label class="sr-only" for="catalog-provider-filter">Filter by provider</label>
            <select
              id="catalog-provider-filter"
              class="w-full appearance-none rounded-full border border-brand-blue-300 bg-brand-gray-500 px-4 py-3 pr-10 text-sm text-white transition focus:border-brand-blue-100 focus:outline-none"
              data-filter-provider-select
            >
              {providerOptions.map((option) => (
                <option value={option.value} class="bg-brand-gray-500 text-white">{option.label}</option>
              ))}
            </select>
            <span class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-brand-blue-100">
              <svg aria-hidden="true" class="size-4" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </span>
          </div>
        </div>
      </div>

      <!-- Meta info and package count -->
      <div class="flex flex-col items-center gap-2 text-xs text-brand-gray-200 sm:flex-row sm:justify-center mb-6">
        <span>Last sync: <span class="font-medium text-white">{formattedLastUpdated}</span></span>
        <span aria-hidden="true" class="hidden sm:inline">•</span>
        <span>Source: <span class="font-medium text-white">{catalogSourceLabel}</span></span>
        <span aria-hidden="true" class="hidden sm:inline">•</span>
        <span>Showing <span class="font-medium text-white" data-active-count>{formatNumber(totalPackages)}</span> packages</span>
      </div>
    </div>
  </section>

  <section class="px-4 pb-20 sm:px-6 lg:px-12">
    <div class="mx-auto max-w-7xl space-y-10">

      <div class="space-y-6">
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3" data-catalog-grid>
          {viewModels.map((pkg) => (
            <article
              role="button"
              tabindex="0"
              class="group relative flex h-full flex-col justify-between rounded-2xl border border-brand-blue-300 bg-brand-blue-500/35 p-6 shadow-[0_18px_40px_rgba(2,62,125,0.25)] transition-transform duration-200 hover:-translate-y-1 hover:shadow-[0_24px_60px_rgba(4,102,200,0.28)] focus-visible:-translate-y-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue-100/70 active:translate-y-0.5 active:shadow-[0_12px_24px_rgba(4,102,200,0.25)]"
              data-catalog-card
              data-labels={pkg.labels.join(",")}
              data-provider-list={pkg.providers.join(",")}
              data-has-ironbank={pkg.hasIronBank ? "true" : "false"}
              data-has-chainguard={pkg.hasChainguard ? "true" : "false"}
              data-vendor-only={pkg.vendorOnly ? "true" : "false"}
              data-search-text={pkg.searchText}
              data-app-id={pkg.id}
              data-app-name={pkg.name}
            >
              <header class="flex flex-col gap-3">
                <div class="flex items-start gap-4">
                  {pkg.logoUrl && (
                    <div class="flex-shrink-0">
                      <img 
                        src={pkg.logoUrl} 
                        alt={`${pkg.name} logo`}
                        class="app-logo"
                        width="48"
                        height="48"
                      />
                    </div>
                  )}
                  <div class="flex-1 min-w-0">
                    <h3 class="text-xl font-semibold text-white">{pkg.name}</h3>
                    <p class="mt-2 text-sm text-brand-gray-100">{pkg.summary}</p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2">
                  {pkg.labels.length ? (
                    pkg.labels.map((label) => (
                      <span class="rounded-full border border-brand-blue-400 bg-brand-blue-500/20 px-3 py-1 text-xs lowercase text-brand-blue-100">
                        {label}
                      </span>
                    ))
                  ) : null}
                </div>
              </header>

              <div class="mt-6 flex flex-col gap-4 text-sm text-brand-gray-100">
                <dl class="grid grid-cols-2 gap-4 text-xs uppercase tracking-[0.2em] text-brand-gray-300">
                  <div class="space-y-2">
                    <dt>Latest version</dt>
                    <dd class="text-base normal-case text-white">{pkg.latestVersion}</dd>
                  </div>
                  <div class="space-y-2">
                    <dt>Images</dt>
                    <dd class="text-base normal-case text-white">{pkg.imageCount}</dd>
                  </div>
                </dl>
                <div class="vulnerability-bar-container">
                  <div class="vulnerability-bar">
                    {severityOrder.map((key) => {
                      const count = pkg.cves?.[key] ?? 0;
                      if (count === 0) return null;
                      const total = severityOrder.reduce((sum, k) => sum + (pkg.cves?.[k] ?? 0), 0);
                      const percentage = total > 0 ? (count / total) * 100 : 0;
                      return (
                        <div
                          class="vulnerability-segment"
                          style={`background: ${severityColorMap[key]}; width: ${percentage}%;`}
                          data-tooltip={`${severityLabelMap[key]}: ${count}`}
                        ></div>
                      );
                    })}
                  </div>
                </div>
              </div>

              <footer class="mt-6 flex flex-wrap items-center gap-3 border-t border-brand-blue-300 pt-5 text-sm text-brand-gray-100">
                {pkg.links.documentation ? (
                  <a
                    class="inline-flex items-center gap-2 rounded-full bg-brand-blue-300 px-4 py-2 font-medium text-white transition hover:bg-brand-blue-100"
                    href={pkg.links.documentation}
                  >
                    View docs
                    <span aria-hidden="true">→</span>
                  </a>
                ) : null}
                {pkg.links.git ? (
                  <a
                    class="inline-flex items-center gap-2 rounded-full border border-brand-blue-400 px-4 py-2 font-medium text-brand-gray-100 transition hover:border-brand-blue-100 hover:text-white"
                    href={pkg.links.git}
                    target="_blank"
                    rel="noreferrer noopener"
                  >
                    Repository
                    <span aria-hidden="true">↗</span>
                  </a>
                ) : null}
                <div class="ml-auto flex items-center gap-2 text-xs font-medium text-brand-blue-100 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-visible:opacity-100">
                  Open details
                  <span aria-hidden="true">⇲</span>
                </div>
              </footer>
            </article>
          ))}
        </div>
        <div
          class="hidden rounded-2xl border border-dashed border-brand-blue-400 bg-brand-gray-500 p-10 text-center text-sm text-brand-gray-100"
          data-empty-state
        >
          No packages match the current filters. Reset the toggles to see the full catalog.
        </div>
      </div>

      <script
        type="application/json"
        id="catalog-view-models"
        set:html={serializeJson(viewModels)}
        is:inline
      ></script>

      <div class="overflow-hidden rounded-2xl border border-brand-blue-400 bg-brand-gray-500">
        <div class="border-b border-brand-blue-400 p-6">
          <h2 class="text-lg font-semibold text-white">Offline readiness matrix</h2>
          <p class="mt-1 text-sm text-brand-gray-100">
            Snapshots catalog coverage for review packages and compliance audits.
          </p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-brand-blue-400 text-left text-sm text-brand-gray-100">
            <thead class="bg-brand-blue-500 text-xs uppercase tracking-[0.2em] text-brand-gray-200">
              <tr>
                <th scope="col" class="px-6 py-4">Package</th>
                <th scope="col" class="px-6 py-4">Latest version</th>
                <th scope="col" class="px-6 py-4">Providers</th>
                <th scope="col" class="px-6 py-4">Iron Bank</th>
                <th scope="col" class="px-6 py-4">Chainguard</th>
                <th scope="col" class="px-6 py-4">Images</th>
                <th scope="col" class="px-6 py-4">Critical / High / Medium / Low</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-brand-blue-400">
              {viewModels.map((pkg) => (
                <tr class="transition hover:bg-brand-blue-400/40">
                  <td class="px-6 py-4 text-white">
                    <div class="font-medium">{pkg.name}</div>
                    <div class="text-xs text-brand-gray-300">{pkg.id}</div>
                  </td>
                  <td class="px-6 py-4">{pkg.latestVersion}</td>
                  <td class="px-6 py-4">{pkg.providers.join(", ") || "—"}</td>
                  <td class="px-6 py-4">{pkg.hasIronBank ? "Yes" : "No"}</td>
                  <td class="px-6 py-4">{pkg.hasChainguard ? "Yes" : "No"}</td>
                  <td class="px-6 py-4">{pkg.imageCount}</td>
                  <td class="px-6 py-4 text-brand-blue-100">{severityToString(pkg.cves)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="fixed inset-0 z-50 hidden" data-manifest-overlay aria-hidden="true">
    <div class="absolute inset-0 bg-brand-blue-500/80 backdrop-blur-sm transition-opacity" data-overlay-backdrop></div>
    <div class="pointer-events-none absolute inset-0 flex items-center justify-center px-4 py-8">
      <article
        class="pointer-events-auto relative w-full max-w-5xl overflow-hidden rounded-3xl border border-brand-blue-400 bg-brand-gray-500 shadow-[0_40px_120px_rgba(2,62,125,0.45)] transition-transform duration-300"
        data-overlay-panel
      >
        <header class="flex flex-col gap-6 border-b border-brand-blue-400 px-8 py-6 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-3">
            <p class="text-xs uppercase tracking-[0.2em] text-brand-gray-300">Disconnected app</p>
            <h3 class="text-2xl font-semibold text-white" data-overlay-title></h3>
            <p class="max-w-2xl text-sm text-brand-gray-100" data-overlay-summary></p>
            <div class="flex flex-wrap gap-2" data-overlay-labels></div>
          </div>
          <div class="flex flex-col items-start gap-3 text-xs text-brand-gray-300 sm:items-end">
            <span class="rounded-full border border-brand-blue-400 px-3 py-1 text-xs font-medium text-brand-gray-100" data-overlay-source></span>
            <span class="text-xs" data-overlay-updated></span>
            <button type="button" class="rounded-full border border-brand-blue-400 px-3 py-1 text-xs text-brand-gray-100 transition hover:border-brand-blue-100 hover:text-white" data-overlay-close>
              Close
            </button>
          </div>
        </header>

        <section class="grid gap-4 border-b border-brand-blue-400 px-8 py-4 text-xs uppercase tracking-[0.2em] text-brand-gray-300 sm:grid-cols-3">
          <div class="space-y-1">
            <p>Latest version</p>
            <p class="text-base normal-case text-white" data-overlay-latest></p>
          </div>
          <div class="space-y-1">
            <p>Images mirrored</p>
            <p class="text-base normal-case text-white" data-overlay-images></p>
          </div>
          <div class="space-y-1">
            <p>Providers</p>
            <p class="text-base normal-case text-white" data-overlay-providers></p>
          </div>
        </section>

        <div class="relative px-8 py-6">
          <div class="flex flex-col items-center justify-center gap-4 py-24" data-overlay-loading>
            <div class="size-12 rounded-full border-2 border-brand-blue-100/40 border-t-brand-blue-100 animate-spin" aria-hidden="true"></div>
            <p class="text-sm text-brand-gray-100" data-overlay-status>Loading manifest…</p>
          </div>

          <div class="hidden" data-overlay-error>
            <div class="rounded-2xl border border-[#F59F00]/40 bg-[#2F1B00] px-6 py-4 text-sm text-[#FFD166]">
              <p class="font-medium">Unable to load manifest</p>
              <p class="mt-1 text-xs text-[#FFC46D]" data-overlay-error-message></p>
            </div>
          </div>

          <div class="hidden space-y-6" data-overlay-content>
            <div class="grid gap-4 md:grid-cols-2">
              <label class="flex flex-col gap-2">
                <span class="text-xs uppercase tracking-[0.2em] text-brand-gray-300">Provider</span>
                <select class="rounded-xl border border-brand-blue-400 bg-brand-blue-500 px-4 py-2 text-sm text-white focus:border-brand-blue-100 focus:outline-none" data-overlay-provider></select>
              </label>
              <label class="flex flex-col gap-2">
                <span class="text-xs uppercase tracking-[0.2em] text-brand-gray-300">Version</span>
                <select class="rounded-xl border border-brand-blue-400 bg-brand-blue-500 px-4 py-2 text-sm text-white focus:border-brand-blue-100 focus:outline-none" data-overlay-version></select>
              </label>
            </div>

            <div class="rounded-3xl border border-brand-blue-400 bg-brand-blue-500/60 p-5">
              <div class="grid gap-6 lg:grid-cols-[minmax(240px,280px),1fr]">
                <div class="space-y-2" data-overlay-image-list></div>
                <div class="space-y-4">
                  <div class="flex flex-wrap gap-2" role="tablist">
                    <button type="button" class="rounded-full border border-brand-blue-400 px-3 py-1 text-xs font-medium text-brand-gray-100 transition data-[active=true]:bg-brand-blue-300 data-[active=true]:text-white" data-overlay-tab="overview">Overview</button>
                    <button type="button" class="rounded-full border border-brand-blue-400 px-3 py-1 text-xs font-medium text-brand-gray-100 transition data-[active=true]:bg-brand-blue-300 data-[active=true]:text-white" data-overlay-tab="scans">Scans</button>
                    <button type="button" class="rounded-full border border-brand-blue-400 px-3 py-1 text-xs font-medium text-brand-gray-100 transition data-[active=true]:bg-brand-blue-300 data-[active=true]:text-white" data-overlay-tab="sboms">SBOMs</button>
                  </div>
                  <div class="min-h-[220px] space-y-4 text-sm text-brand-gray-100" data-overlay-tab-content></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </div>
  </div>

  <script
    type="application/json"
    id="catalog-cve-data"
    set:html={serializeJson(cveChartPayload)}
    is:inline
  ></script>

  <script type="module" src="/catalog-page.js" is:inline></script>
</BaseLayout>

<style>
  .vulnerability-bar-container {
    margin-top: 0.5rem;
    position: relative;
    z-index: 1;
  }

  .vulnerability-bar {
    display: flex;
    height: 0.5rem;
    width: 100%;
    border-radius: 0.25rem;
    overflow: visible;
    background: rgba(51, 65, 92, 0.3);
  }

  .vulnerability-segment {
    height: 100%;
    position: relative;
    transition: transform 0.2s ease;
    cursor: pointer;
  }

  .vulnerability-segment:hover {
    transform: scaleY(1.3);
    z-index: 10;
  }

  .vulnerability-segment::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(0, 18, 51, 0.98);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease, transform 0.2s ease;
    border: 1px solid rgba(4, 102, 200, 0.5);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    z-index: 20;
  }

  .vulnerability-segment:hover::before {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }

  /* Arrow for tooltip */
  .vulnerability-segment::after {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid rgba(0, 18, 51, 0.98);
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 20;
  }

  .vulnerability-segment:hover::after {
    opacity: 1;
  }

  /* App logo styling */
  .app-logo {
    width: 48px;
    height: 48px;
    object-fit: contain;
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    padding: 0.25rem;
  }
</style>
